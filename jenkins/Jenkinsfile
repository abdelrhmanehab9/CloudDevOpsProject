@Library('shared-library') _

pipeline {
    agent any

    environment {
        DOCKER_REGISTRY = "docker.io"
        DOCKER_USERNAME = "abdelrhmanehab11"
        IMAGE_NAME = "abdelrhmanehab11/test"
        IMAGE_TAG = "${BUILD_NUMBER}"
        GIT_REPO = "https://github.com/abdelrhmanehab9/CloudDevOpsProject.git"
        GIT_BRANCH = "main"
        MANIFEST_DIR = "kubernetes/manifests"
    }

    options {
        buildDiscarder(logRotator(numToKeepStr: '10'))
        timeout(time: 1, unit: 'HOURS')
        timestamps()
    }

    stages {
        stage('Checkout') {
            steps {
                script {
                    echo "üîÑ Checking out code from Git..."
                    checkout([
                        $class: 'GitSCM',
                        branches: [[name: "*/${GIT_BRANCH}"]],
                        userRemoteConfigs: [[url: "${GIT_REPO}"]]
                    ])
                }
            }
        }

        stage('Build Image') {
            steps {
                script {
                    echo "üêã Building Docker image..."
                    buildImage(
                        imageName: "${IMAGE_NAME}",
                        imageTag: "${IMAGE_TAG}",
                        dockerfile: "docker/Dockerfile",
                        context: "docker"
                    )
                }
            }
        }

        stage('Scan Image') {
            steps {
                script {
                    echo "üîç Scanning Docker image with Trivy..."
                    scanImage(
                        imageName: "${IMAGE_NAME}",
                        imageTag: "${IMAGE_TAG}",
                        severity: "HIGH,CRITICAL"
                    )
                }
            }
        }

        stage('Push Image') {
            steps {
                script {
                    echo "üì§ Pushing image to DockerHub..."
                    withCredentials([usernamePassword(credentialsId: 'docker-hub-creds', usernameVariable: 'DOCKER_USER', passwordVariable: 'DOCKER_PASS')]) {
                        sh """
                            echo "\${DOCKER_PASS}" | docker login ${DOCKER_REGISTRY} -u "\${DOCKER_USER}" --password-stdin
                        """
                        pushImage(
                            imageName: "${IMAGE_NAME}",
                            imageTag: "${IMAGE_TAG}"
                        )
                        sh "docker logout ${DOCKER_REGISTRY}"
                    }
                }
            }
        }

        stage('Delete Local Image') {
            steps {
                script {
                    echo "üóëÔ∏è Deleting local Docker image..."
                    sh """
                        docker rmi ${IMAGE_NAME}:${IMAGE_TAG} || true
                        docker rmi ${IMAGE_NAME}:latest || true
                        echo "‚úÖ Local images deleted"
                    """
                }
            }
        }

        stage('Update Manifests') {
            steps {
                script {
                    echo "üìù Updating Kubernetes manifests with new image..."
                    updateManifests(
                        manifestDir: "${MANIFEST_DIR}",
                        imageName: "${IMAGE_NAME}",
                        imageTag: "${IMAGE_TAG}"
                    )
                }
            }
        }

        stage('Commit & Push Manifests') {
            steps {
                script {
                    echo "üì§ Committing and pushing updated manifests..."
                    withCredentials([usernamePassword(credentialsId: 'Github-creds', usernameVariable: 'GIT_USER', passwordVariable: 'GIT_PASS')]) {
                        sh """
                            cd ${WORKSPACE}
                            git config user.name "Jenkins CI"
                            git config user.email "jenkins@clouddevops.local"
                            git add ${MANIFEST_DIR}/*
                            git commit -m "Update image to ${IMAGE_NAME}:${IMAGE_TAG} [Build #${BUILD_NUMBER}]" || echo "No changes to commit"
                            git push https://${GIT_USER}:${GIT_PASS}@github.com/abdelrhmanehab9/CloudDevOpsProject.git ${GIT_BRANCH} || echo "Push failed or nothing to push"
                        """
                    }
                }
            }
        }
    }

    post {
        always {
            script {
                node {
                    echo "üßπ Cleanup and archiving artifacts..."
                    cleanWs()
                }
            }
        }

        success {
            echo "‚úÖ Pipeline succeeded! Image ${IMAGE_NAME}:${IMAGE_TAG} deployed successfully!"
        }

        failure {
            echo "‚ùå Pipeline failed! Check logs for details."
        }
    }
}
